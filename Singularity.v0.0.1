Bootstrap: docker
From: ubuntu:20.04

%help
  First level fMRI analysis for specific GenFac tasks
  Info and usage:
    /opt/gf-fmri/README.md


%setup
  mkdir -p ${SINGULARITY_ROOTFS}/opt/gf-fmri


%files
  src                          /opt/gf-fmri
  matlab                       /opt/gf-fmri
  README.md                    /opt/gf-fmri

 
%labels
  Maintainer baxter.rogers@vanderbilt.edu


%post
  apt-get update
  apt-get install -y wget unzip zip xvfb ghostscript imagemagick bc   # Misc tools
  apt-get install -y openjdk-8-jre                                    # Matlab
  apt-get install -y libopenblas-base language-pack-en                # FSL
  
  # Fix imagemagick policy to allow PDF output. See https://usn.ubuntu.com/3785-1/
  sed -i 's/rights="none" pattern="PDF"/rights="read | write" pattern="PDF"/' \
    /etc/ImageMagick-6/policy.xml
  
  # Download the Matlab Compiled Runtime installer, install, clean up
  mkdir /MCR
  wget -nv -P /MCR https://ssd.mathworks.com/supportfiles/downloads/R2019b/Release/6/deployment_files/installer/complete/glnxa64/MATLAB_Runtime_R2019b_Update_6_glnxa64.zip
  unzip /MCR/MATLAB_Runtime_R2019b_Update_6_glnxa64.zip -d /MCR/MATLAB_Runtime_R2019b_Update_6_glnxa64
  /MCR/MATLAB_Runtime_R2019b_Update_6_glnxa64/install -mode silent -agreeToLicense yes
  rm -r /MCR/MATLAB_Runtime_R2019b_Update_6_glnxa64 /MCR/MATLAB_Runtime_R2019b_Update_6_glnxa64.zip
  rmdir /MCR

  # We need FSL
  wget -nv -P /opt https://fsl.fmrib.ox.ac.uk/fsldownloads/fsl-6.0.0-centos7_64.tar.gz
  cd /usr/local
  tar -zxf fsl-6.0.0-centos7_64.tar.gz
  rm fsl-6.0.0-centos7_64.tar.gz

  # Create input/output directories for binding
  mkdir /INPUTS && mkdir /OUTPUTS

  # Singularity-hub doesn't work with github LFS (it gets the pointer info instead 
  # of the actual file) so we get the compiled matlab executable via direct download.
  # Not needed for local build.
  rm /opt/gf-fmri/bin/spm12.ctf
  wget -nv -P /opt/gf-fmri/matlab/bin https://github.com/baxpr/gf-fmri/raw/master/matlab/bin/spm12.ctf

  # We need to run the matlab executable now to extract the CTF, because
  # now is the only time the container is writeable
  /opt/gf-fmri/matlab/bin/run_spm12.sh /usr/local/MATLAB/MATLAB_Runtime/v97 function exit


%environment

  # Matlab shell. We don't need to set the Matlab library path here, because 
  # Matlab's auto-generated run_??.sh script does it for us.
  MATLAB_SHELL=/bin/bash

  # FSL (we only use fslstats so no need for the full setup)
  export FSLDIR=/usr/local/fsl
  
  # Path
  export PATH=/opt/gf-fmri/src:/usr/local/fsl/bin:${PATH}


%runscript
  xvfb-run --server-num=$(($$ + 99)) \
  --server-args='-screen 0 1600x1200x24 -ac +extension GLX' \
  bash /opt/gf-fmri/matlab/bin/run_spm12.sh \
  /usr/local/MATLAB/MATLAB_Runtime/v97 function gf-fmri "$@"

